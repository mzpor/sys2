# سناریوی بهبودیافته ربات مدیریت تلاوت قرآن

این سند نسخه بهبودیافته‌ای از سناریوی ربات مدیریت تلاوت قرآن را ارائه می‌دهد که نقاط ضعف نسخه قبلی را برطرف کرده و قابلیت‌های جدیدی اضافه می‌کند. این سناریو شامل فرآیند ثبت‌نام خصوصی، کیبوردهای تعاملی، بکاپ خودکار، و یادآوری‌های شخصی‌سازی‌شده است.

---

## پیکربندی اولیه

### تنظیمات و توکن‌ها
- **توکن ربات**:
  ```python
  BOT_TOKEN = '811316021:qhTkuourrvpM4nF1xrE6MyD93rSgJBfVZFwXbJU1'
  BASE_URL = f"https://tapi.bale.ai/bot{BOT_TOKEN}"
  ```
- **فایل‌های داده**:
  - داده‌های اصلی: `bot_data.json`
  - بکاپ: `bot_data_backup_[YYYYMMDD].json`
- **پیام‌های انگیزشی**:
  ```python
  motivational_quotes = [
      "🌟 تلاوتت، نور قلبت رو بیشتر می‌کنه!",
      "🚀 هر تلاوت، یه قدم به سوی کماله!",
      "💪 با تمرین مداوم، ستاره گروه باش!"
  ]
  ```
- **روزهای برنامه**:
  - ارسال تلاوت: شنبه و دوشنبه
  - نمره‌دهی: یکشنبه و سه‌شنبه
  - حضور و غیاب: پنج‌شنبه
  - استراحت: چهارشنبه و جمعه
- **ادمین‌ها**:
  - شناسایی از طریق API (`getChatAdministrators`) و ذخیره در حافظه.

### ذخیره‌سازی و بکاپ
- **ذخیره‌سازی**:
  - داده‌ها در `bot_data.json` ذخیره می‌شوند.
  - بکاپ خودکار روزانه در `bot_data_backup_[YYYYMMDD].json`.
- **بارگذاری**:
  - در صورت خرابی فایل اصلی، از آخرین بکاپ بازیابی می‌شود.
- **لاگ‌گیری**:
  - لاگ‌ها در فایل `bot.log` و کنسول ذخیره می‌شوند.

---

## سناریوی کاربری

### ۱. ثبت‌نام خصوصی (جدید)
- **دستور `/start` در چت خصوصی**:
  - پیام خوش‌آمدگویی:
    ```
    🌟 خوش آمدید به ربات تلاوت قرآن!
    لطفاً برای ثبت‌نام، نام و نام خانوادگی خود را وارد کنید (مثال: علی رضایی).
    ```
  - **مراحل ثبت‌نام**:
    1. دریافت نام و نام خانوادگی:
       - اعتبارسنجی: حداقل دو کلمه.
       - پیام:
         ```
         [نام کوچک] عزیز،
         نام شما: [نام کامل]
         کد ملی: هنوز وارد نشده
         تلفن: هنوز وارد نشده
         لطفاً کد ملی ۱۰ رقمی خود را وارد کنید.
         ```
       - کیبورد شیشه‌ای:
         ```python
         [[{"text": "✏️ تصحیح نام", "callback_data": "edit_name"}]]
         ```
    2. دریافت کد ملی:
       - اعتبارسنجی: دقیقاً ۱۰ رقم (فقط اعداد انگلیسی).
       - پیام:
         ```
         [نام کوچک] عزیز،
         نام شما: [نام کامل]
         کد ملی: [کد ملی]
         تلفن: هنوز وارد نشده
         لطفاً شماره تلفن خود را ارسال کنید.
         ```
       - کیبورد شیشه‌ای:
         ```python
         [
             [{"text": "✏️ تصحیح کد ملی", "callback_data": "edit_national_id"}],
             [{"text": "📱 ارسال شماره تلفن", "request_contact": True}]
         ]
         ```
    3. دریافت شماره تلفن:
       - اعتبارسنجی: باید از دکمه تماس ارسال شود.
       - پیام:
         ```
         📋 [نام کوچک] عزیز،
         نام شما: [نام کامل]
         کد ملی: [کد ملی]
         تلفن: [شماره تلفن]
         آیا اطلاعات درست است؟
         ```
       - کیبورد شیشه‌ای:
         ```python
         [
             [{"text": "✅ تأیید نهایی", "callback_data": "final_confirm"}],
             [{"text": "✏️ تصحیح نام", "callback_data": "edit_name"}],
             [{"text": "✏️ تصحیح کد ملی", "callback_data": "edit_national_id"}],
             [{"text": "📱 تصحیح شماره تلفن", "callback_data": "edit_phone"}]
         ]
         ```
    4. تأیید نهایی:
       - ذخیره اطلاعات در `known_members`:
         ```python
         known_members[chat_id][user_id] = {
             "first_name": first_name,
             "last_name": last_name,
             "national_id": national_id,
             "mobile": mobile,
             "added_time": time.time()
         }
         ```
       - پیام:
         ```
         🎉 ثبت‌نام شما با موفقیت انجام شد!
         لطفاً به گروه بپیوندید: [لینک گروه]
         ```
###########################################################################################
### ۲. ورود عضو جدید به گروه
- **اقدام**:
  - اگر کاربر در `known_members` ثبت شده باشد:
    - پیام خوش‌آمدگویی:
      ```
      🎉 [نام کاربر]، به گروه خوش آمدید!
      شما قبلاً ثبت‌نام کرده‌اید.
      ```
  - اگر ثبت‌نام نکرده باشد:
    - پیام:
      ```
      🎉 [نام کاربر]، به گروه خوش آمدید!
      لطفاً برای ثبت‌نام، در چت خصوصی /start را بزنید.
      ```
  - به‌روزرسانی لیست اعضا و ارسال آن.

### ۳. ارسال تمرین تلاوت
- **شرایط**:
  - روز ارسال تلاوت (شنبه یا دوشنبه).
  - فایل صوتی با کپشن شامل کلمات کلیدی (`تلاوت`، `تمرین`، `ارسال تلاوت`).
  - حداقل مدت‌زمان صوت: ۳۰ ثانیه (اعتبارسنجی جدید).
- **اقدام**:
  - ثبت تلاوت:
    ```python
    recitation_exercises[chat_id][user_id] = {
        "status": "sent",
        "score": None,
        "date": get_jalali_date(),
        "message_id": message["message_id"],
        "user_name": user_name,
        "exercise_day": get_week_day(),
        "duration": message.get("voice", {}).get("duration", 0)
    }
    ```
  - پیام تأیید:
    ```
    ✅ تلاوت [نام کاربر] دریافت شد!
    ```
  - کیبورد شیشه‌ای:
    ```python
    [[{"text": "🔙 لغو تلاوت", "callback_data": "cancel_recitation"}]]
    ```
  - یادآوری شخصی (جدید):
    - به کاربرانی که تا ساعت ۲۰:۰۰ تلاوت ارسال نکرده‌اند:
      ```
      ⏳ [نام کاربر] عزیز، لطفاً تلاوت امروز خود را تا ساعت ۲۳:۵۹ ارسال کنید!
      ```

### ۴. نمره‌دهی
- **شرایط**:
  - ادمین به پیام تلاوت پاسخ دهد.
  - نمره معتبر: `نیاز به تلاش بیشتر`، `متوسط`، `خوب`، `عالی`، `ممتاز`.
- **اقدام**:
  - ثبت نمره و ارسال پیام تأیید.
  - کیبورد شیشه‌ای برای تأیید یا اصلاح نمره:
    ```python
    [
        [{"text": "✅ تأیید نمره", "callback_data": "confirm_score"}],
        [{"text": "✏️ اصلاح نمره", "callback_data": "edit_score"}]
    ]
    ```

### ۵. حضور و غیاب
- **شرایط**:
  - روز پنج‌شنبه، ادمین پاسخ به پیام کاربر با `حاضر` یا `غایب`.
- **اقدام**:
  - ثبت وضعیت و ارسال پیام تأیید.
  - کیبورد شیشه‌ای:
    ```python
    [[{"text": "🔙 بازگشت", "callback_data": "back_to_menu"}]]
    ```

### ۶. پنل مدیریتی (جدید)
- **دستور `/مدیریت`** (فقط ادمین):
  - پیام:
    ```
    👑 به پنل مدیریتی خوش آمدید!
    ```
  - کیبورد شیشه‌ای:
    ```python
    [
        [{"text": "📊 آمار کاربران", "callback_data": "admin_stats"}],
        [{"text": "📚 مدیریت کلاس‌ها", "callback_data": "admin_manage_classes"}],
        [{"text": "🗑️ حذف کاربر", "callback_data": "admin_delete_user"}],
        [{"text": "🔙 خروج", "callback_data": "exit_admin_panel"}]
    ]
    ```
  - **آمار کاربران**: نمایش تعداد اعضا، مشارکت، و گزارش‌ها.
  - **مدیریت کلاس‌ها**: افزودن، ویرایش، یا حذف کلاس‌ها.
  - **حذف کاربر**: حذف اطلاعات کاربر از `known_members`.

### ۷. گزارش‌ها و لیست‌ها
- **گزارش تلاوت‌ها** (`/گزارش`):
  - مشابه نسخه قبلی، با کیبورد برای فیلتر کردن گزارش‌ها:
    ```python
    [[{"text": "📅 گزارش روز خاص", "callback_data": "report_by_date"}]]
    ```
- **گزارش نمرات** (`/نمرات`):
  - مشابه نسخه قبلی، با امکان فیلتر بر اساس کاربر یا تاریخ.
- **لیست اعضا** (`/لیست`):
  - شامل اطلاعات بیشتر (مانند شماره تلفن برای ادمین‌ها).

---

## نکات نهایی
- **تجربه کاربری**: کیبوردهای تعاملی و یادآوری‌های شخصی، مشارکت را افزایش می‌دهند.
- **پایداری**: بکاپ خودکار و مدیریت پیشرفته خطاها، از دست رفتن داده‌ها را به حداقل می‌رساند.
- **انعطاف‌پذیری**: پشتیبانی از چت خصوصی و پنل مدیریتی، قابلیت توسعه را بهبود می‌بخشد.
- **امنیت**: محدود کردن اقدامات حساس به ادمین‌ها و اعتبارسنجی دقیق.