# 📝 راهنمای ماژول ثبت‌نام (Registration Module)

## 🎯 هدف
ماژول ثبت‌نام برای مدیریت فرآیند ثبت‌نام کاربران غیر مدیر/مربی/کمک مربی در مدرسه تلاوت طراحی شده است.

## 🔧 ویژگی‌ها

### 👥 مدیریت نقش‌ها
- **مدیران**: دسترسی کامل به پنل مدیریتی
- **مربیان**: دسترسی به پنل مربی
- **کمک مربیان**: دسترسی به پنل کمک مربی
- **قرآن‌آموزان**: دسترسی به پنل قرآن‌آموز و ثبت‌نام

### 📋 فرآیند ثبت‌نام
1. **نام و نام خانوادگی**: ورود نام کامل
2. **کد ملی**: ورود کد ملی ۱۰ رقمی
3. **شماره تلفن**: ارسال شماره تلفن از طریق دکمه
4. **تأیید نهایی**: بررسی و تأیید اطلاعات

### 🎛️ کیبوردها
- **کیبورد معمولی**: برای دکمه‌های اصلی
- **کیبورد شیشه‌ای**: برای دکمه‌های عملیاتی
- **کیبورد تماس**: برای ارسال شماره تلفن

## 📁 فایل‌های مرتبط

### `registration_module.py`
ماژول اصلی ثبت‌نام که شامل:
- کلاس `RegistrationModule`
- مدیریت پیام‌ها و callback ها
- ذخیره و بارگذاری داده‌ها
- اعتبارسنجی اطلاعات

### `registration_data.json`
فایل ذخیره داده‌های ثبت‌نام کاربران

## 🔄 جریان کار

### برای کاربران غیر مدیر/مربی/کمک مربی:

#### 1️⃣ شروع (`/start`)
```
🌟 خوش آمدید! به مدرسه تلاوت خوش آمدید!

[شروع مجدد] [معرفی مدرسه] [خروج]
[ثبت‌نام]
```

#### 2️⃣ معرفی مدرسه
```
🏫 معرفی مدرسه تلاوت

مدرسه تلاوت با بیش از ۱۰ سال سابقه...

[📝 ثبت‌نام]
```

#### 3️⃣ فرآیند ثبت‌نام
```
لطفاً نام و نام خانوادگی خود را وارد کنید (مثال: علی رضایی).

[شروع مجدد] [خروج] [برگشت به قبل]
```

#### 4️⃣ تأیید نهایی
```
📋 علی عزیز، حساب کاربری شما:
نام: علی رضایی
کد ملی: 1234567890
تلفن: +989123456789

[✅ تأیید نهایی] [✏️ تصحیح اطلاعات]
```

### برای کاربران ثبت‌نام شده:
```
🌟 علی عزیز، خوش آمدی!
حساب کاربری شما آماده است 👇
نام: علی رضایی
کد ملی: 1234567890
تلفن: +989123456789

[✏️ تصحیح اطلاعات] [📚 پنل قرآن‌آموز]
```

## 🛠️ API ها

### متدهای اصلی

#### `handle_message(message: Dict)`
پردازش پیام‌های متنی از کاربران

#### `handle_callback(callback: Dict)`
پردازش callback query ها

#### `is_admin_or_teacher(user_id: int) -> bool`
بررسی اینکه آیا کاربر مدیر یا مربی است

#### `is_user_registered(user_id: str) -> bool`
بررسی اینکه آیا کاربر ثبت‌نام کرده است

#### `get_user_role(user_id: int) -> str`
دریافت نقش کاربر (مدیر/مربی/کمک مربی/قرآن‌آموز)

### متدهای کمکی

#### `build_reply_keyboard(buttons: List[List[str]]) -> Dict`
ساخت کیبورد معمولی

#### `build_inline_keyboard(buttons: List[List[Dict]]) -> Dict`
ساخت کیبورد شیشه‌ای

#### `is_valid_national_id(nid: str) -> bool`
اعتبارسنجی کد ملی

## 🔗 اتصال به سیستم اصلی

### در `main.py`:
```python
from registration_module import RegistrationModule

class AttendanceBot:
    def __init__(self):
        self.registration_module = RegistrationModule()
        # ...

    def process_update(self, update):
        # بررسی اولویت registration_module
        if hasattr(self.registration_module, 'user_states') and str(user_id) in self.registration_module.user_states:
            self.registration_module.handle_message(message)
        # ...
```

## 📊 آمار و گزارش‌گیری

### `get_registered_users_count() -> int`
دریافت تعداد کاربران ثبت‌نام شده

### `get_all_users_count() -> int`
دریافت تعداد کل کاربران

### `export_user_data(user_id: str) -> Optional[Dict]`
صادرات اطلاعات کاربر

## 🧪 تست

### اجرای تست:
```bash
python test_registration.py
```

### تست‌های موجود:
- بررسی نقش کاربران
- اعتبارسنجی کد ملی
- ساخت کیبوردها
- بررسی ثبت‌نام کاربران

## ⚙️ تنظیمات

### در `config.py`:
```python
ADMIN_USER_IDS = [1114227010, 1775811194]
AUTHORIZED_USER_IDS = [574330749, 1114227010, 1775811194]
HELPER_COACH_USER_IDS = [2045777722]
```

## 🚀 نحوه استفاده

1. **شروع ربات**: `python main.py`
2. **ارسال `/start`**: برای شروع فرآیند
3. **انتخاب "ثبت‌نام"**: برای شروع ثبت‌نام
4. **تکمیل اطلاعات**: نام، کد ملی، شماره تلفن
5. **تأیید نهایی**: تکمیل ثبت‌نام

## 🔧 عیب‌یابی

### مشکلات رایج:

#### خطای بارگذاری config:
```
Error loading config: [Errno 2] No such file or directory: 'config.py'
```
**راه حل**: اطمینان از وجود فایل `config.py`

#### خطای ذخیره داده:
```
Error saving registration data: [Errno 13] Permission denied
```
**راه حل**: بررسی مجوزهای نوشتن در پوشه

#### خطای API تلگرام:
```
Telegram API error: Bot was blocked by the user
```
**راه حل**: کاربر ربات را بلاک کرده است

## 📝 نکات مهم

1. **اولویت پردازش**: registration_module اولویت بالاتری دارد
2. **ذخیره داده**: اطلاعات در `registration_data.json` ذخیره می‌شود
3. **اعتبارسنجی**: کد ملی باید دقیقاً ۱۰ رقم باشد
4. **نقش‌ها**: بر اساس `config.py` تعیین می‌شوند
5. **کیبوردها**: به صورت خودکار ساخته می‌شوند

## 🔄 به‌روزرسانی‌های آینده

- [ ] اضافه کردن تأیید ایمیل
- [ ] پشتیبانی از آپلود عکس پروفایل
- [ ] سیستم کد تأیید SMS
- [ ] گزارش‌گیری پیشرفته
- [ ] اتصال به پایگاه داده 