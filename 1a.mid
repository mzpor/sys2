# سناریوی ربات ثبت‌نام قرآن‌آموزان و مدیریت تمرین‌های تلاوت قرآن

## مقدمه
این ربات برای مدیریت فرآیند ثبت‌نام قرآن‌آموزان در کلاس‌های تلاوت قرآن و مدیریت تمرین‌های تلاوت در گروه‌های بله طراحی شده است. ربات قابلیت‌هایی مانند ثبت‌نام خصوصی، مدیریت حساب کاربری، ارسال و ارزیابی تمرین‌های تلاوت، و ارائه گزارش‌های مختلف را فراهم می‌کند. در ادامه، سناریوی عملکرد ربات به‌صورت قدم‌به‌قدم شرح داده شده است.

---

## سناریوی کلی

### ۱. **راه‌اندازی اولیه ربات**
   - **قدم‌ها**:
     1. ربات با توکن مشخص (BOT_TOKEN) و آدرس API بله راه‌اندازی می‌شود.
     2. اطلاعات کلاس‌های موجود (مانند دوره آموزش تلاوت قرآن و دوره تخصصی تجوید) در دیکشنری `CLASSES` ذخیره می‌شود.
     3. لینک‌های پرداخت برای هر کلاس در دیکشنری `PAYMENT_LINKS` تعریف شده‌اند.
     4. فایل تنظیمات لاگ با استفاده از ماژول `logging` برای ثبت گزارش‌ها و خطاها پیکربندی می‌شود.
     5. اطلاعات کاربران ثبت‌شده از فایل `1.txt` بارگذاری می‌شود (در صورت وجود).
   - **هدف**: آماده‌سازی ربات برای دریافت و پردازش پیام‌ها و مدیریت داده‌ها.

### ۲. **حلقه اصلی ربات (`main`)**
   - **قدم‌ها**:
     1. ربات در یک حلقه بی‌نهایت اجرا می‌شود و با استفاده از تابع `get_updates` به‌روزرسانی‌های جدید (پیام‌ها و callbackها) را از API بله دریافت می‌کند.
     2. هر به‌روزرسانی بررسی می‌شود:
        - اگر شامل پیام (`message`) باشد، به تابع `process_message` یا توابع مرتبط (مانند `process_new_chat_member`, `handle_recitation_exercise`, `handle_admin_score`) ارجاع داده می‌شود.
        - اگر شامل callback query (کلیک روی دکمه‌های شیشه‌ای) باشد، به تابع `handle_callback_query` ارجاع داده می‌شود.
     3. شناسه آخرین به‌روزرسانی (`offset`) به‌روز می‌شود تا پیام‌های تکراری پردازش نشوند.
     4. در صورت بروز خطا، تأخیر بین درخواست‌ها افزایش می‌یابد (حداکثر 10 ثانیه) تا فشار روی سرور کاهش یابد.
   - **هدف**: دریافت و پردازش مداوم پیام‌ها و دستورات کاربران.

---

## سناریوی ثبت‌نام خصوصی

### ۱. **شروع فرآیند ثبت‌نام**
   - **شرایط**: کاربر در چت خصوصی دستور `/start` را وارد می‌کند یا روی دکمه "ثبت‌نام در مدرسه تلاوت" کلیک می‌کند.
   - **قدم‌ها**:
     1. اگر کاربر قبلاً ثبت‌نام کرده باشد (در `registered_users`)، منوی اصلی با گزینه‌های "کلاس جدید"، "حساب کاربری"، "نظرسنجی" و "درباره ربات" نمایش داده می‌شود.
     2. اگر کاربر جدید باشد، منوی اصلی با گزینه‌های "معرفی مدرسه تلاوت"، "ثبت‌نام در مدرسه تلاوت"، "نظرسنجی" و "درباره ربات" نمایش داده می‌شود.
     3. کاربر روی "ثبت‌نام در مدرسه تلاوت" کلیک می‌کند و فرآیند ثبت‌نام آغاز می‌شود.
     4. ربات از کاربر می‌خواهد نام و نام خانوادگی خود را وارد کند (مثال: محمدی علی).
   - **هدف**: شروع فرآیند ثبت‌نام برای کاربران جدید یا نمایش گزینه‌های مناسب برای کاربران ثبت‌شده.

### ۲. **وارد کردن نام و نام خانوادگی**
   - **شرایط**: کاربر در حالت `waiting_name_lastname` است.
   - **قدم‌ها**:
     1. کاربر نام و نام خانوادگی را وارد می‌کند (مثال: محمدی علی).
     2. ربات متن را پردازش می‌کند:
        - اگر ورودی شامل حداقل دو بخش (نام و نام خانوادگی) باشد، اطلاعات در `private_signup_states` ذخیره می‌شود.
        - در غیر این صورت، پیام خطا نمایش داده می‌شود و از کاربر خواسته می‌شود دوباره وارد کند.
     3. پس از تأیید نام، ربات یک دکمه پایین با قابلیت اشتراک‌گذاری شماره تلفن (`request_contact`) نمایش می‌دهد.
     4. یک دکمه شیشه‌ای برای "تصحیح نام" نیز ارسال می‌شود.
   - **هدف**: دریافت و تأیید نام و نام خانوادگی کاربر.

### ۳. **وارد کردن شماره تلفن**
   - **شرایط**: کاربر در حالت `waiting_phone_contact` است و روی دکمه "ارسال شماره تلفن" کلیک می‌کند.
   - **قدم‌ها**:
     1. کاربر شماره تلفن خود را از طریق دکمه اشتراک‌گذاری تماس ارسال می‌کند.
     2. ربات شماره تلفن را در `private_signup_states` ذخیره می‌کند.
     3. اطلاعات تأیید شده (نام، نام خانوادگی، شماره تلفن) نمایش داده می‌شود.
     4. ربات از کاربر می‌خواهد کد ملی خود را وارد کند و دکمه‌های "وارد کردن کد ملی"، "نظرسنجی"، "درباره ربات" و "ثبت‌نام از اول" نمایش داده می‌شود.
   - **هدف**: دریافت و ذخیره شماره تلفن کاربر.

### ۴. **وارد کردن کد ملی**
   - **شرایط**: کاربر در حالت `waiting_national_id` است.
   - **قدم‌ها**:
     1. کاربر کد ملی 10 رقمی (فقط اعداد انگلیسی) را وارد می‌کند.
     2. ربات با استفاده از regex بررسی می‌کند که کد ملی معتبر باشد (10 رقم، بدون حروف یا اعداد فارسی).
     3. اگر معتبر باشد، کد ملی در `private_signup_states` ذخیره می‌شود و اطلاعات نهایی (نام، نام خانوادگی، شماره تلفن، کد ملی) نمایش داده می‌شود.
     4. دکمه‌های "ورود به انتخاب کلاس" و "تصحیح کد ملی" نمایش داده می‌شود.
     5. اگر کد ملی نامعتبر باشد، پیام خطا نمایش داده می‌شود و کاربر باید دوباره تلاش کند.
   - **هدف**: دریافت و تأیید کد ملی کاربر.

### ۵. **انتخاب کلاس**
   - **شرایط**: کاربر روی دکمه "ورود به انتخاب کلاس" کلیک می‌کند یا در حالت `waiting_for_class_selection` است.
   - **قدم‌ها**:
     1. ربات لیست کلاس‌ها (مانند "دوره آموزش تلاوت قرآن" و "دوره تخصصی تجوید") را با دکمه‌های شیشه‌ای نمایش می‌دهد.
     2. کاربر یک کلاس را انتخاب می‌کند (مثلاً با کلیک روی `select_class_quran_recitation`).
     3. اطلاعات کلاس (نام، هزینه، برنامه) نمایش داده می‌شود و دکمه "لینک پرداخت" ارائه می‌شود.
   - **هدف**: انتخاب کلاس مورد نظر توسط کاربر.

### ۶. **پرداخت و نهایی‌سازی ثبت‌نام**
   - **شرایط**: کاربر روی دکمه "لینک پرداخت" کلیک می‌کند.
   - **قدم‌ها**:
     1. ربات لینک پرداخت مربوط به کلاس انتخاب‌شده را از `PAYMENT_LINKS` نمایش می‌دهد.
     2. کاربر پس از پرداخت، روی دکمه "پرداخت کردم" کلیک می‌کند.
     3. اطلاعات کاربر (نام، نام خانوادگی، شماره تلفن، کد ملی، کلاس انتخاب‌شده) در `registered_users` ذخیره می‌شود.
     4. اطلاعات به فایل `1.txt` ذخیره می‌شود.
     5. اگر کاربر در حال ویرایش اطلاعات باشد، پیام "اطلاعات به‌روزرسانی شد" نمایش داده می‌شود.
     6. اگر ثبت‌نام جدید باشد، پیام تبریک با لینک کانال آموزشی و منوی اصلی نمایش داده می‌شود.
   - **هدف**: نهایی‌سازی ثبت‌نام و ذخیره اطلاعات کاربر.

### ۷. **مدیریت حساب کاربری**
   - **شرایط**: کاربر روی دکمه "حساب کاربری" کلیک می‌کند.
   - **قدم‌ها**:
     1. اگر کاربر ثبت‌شده باشد، اطلاعات او (نام، نام خانوادگی، شماره تلفن، کد ملی، کلاس ثبت‌شده) نمایش داده می‌شود.
     2. دکمه‌های "کلاس جدید"، "تصحیح اطلاعات" و "بازگشت به منو" ارائه می‌شود.
     3. اگر کاربر ثبت‌نام نکرده باشد، پیام "شما هنوز ثبت‌نام نکرده‌اید" با دکمه‌های "ثبت‌نام در مدرسه" و "بازگشت به منو" نمایش داده می‌شود.
   - **هدف**: نمایش و مدیریت اطلاعات حساب کاربری.

### ۸. **تصحیح اطلاعات**
   - **شرایط**: کاربر روی دکمه "تصحیح اطلاعات"، "تصحیح نام"، "تصحیح شماره تلفن" یا "تصحیح کد ملی" کلیک می‌کند.
   - **قدم‌ها**:
     1. برای "تصحیح اطلاعات"، فرآیند ثبت‌نام از مرحله وارد کردن نام و نام خانوادگی آغاز می‌شود (با پر کردن اطلاعات قبلی).
     2. برای "تصحیح نام"، کاربر دوباره نام و نام خانوادگی وارد می‌کند.
     3. برای "تصحیح شماره تلفن"، دکمه اشتراک‌گذاری شماره تلفن نمایش داده می‌شود.
     4. برای "تصحیح کد ملی"، کاربر باید کد ملی جدید وارد کند.
     5. اطلاعات به‌روزرسانی‌شده ذخیره می‌شوند.
   - **هدف**: امکان ویرایش اطلاعات ثبت‌شده توسط کاربر.

---

## سناریوی مدیریت گروه

### ۱. **ورود عضو جدید به گروه**
   - **شرایط**: یک عضو جدید به گروه اضافه می‌شود (`new_chat_members` در پیام).
   - **قدم‌ها**:
     1. اطلاعات کاربر جدید (شناسه، نام، نام خانوادگی) در `known_members` ذخیره می‌شود.
     2. اگر کاربر ادمین نباشد، پیام خوش‌آمدگویی با درخواست زدن دستور `/عضو` ارسال می‌شود.
   - **هدف**: ثبت عضو جدید و دعوت به عضویت رسمی.

### ۲. **ثبت‌نام در گروه با دستور `/عضو`**
   - **شرایط**: کاربر غیرادمین دستور `/عضو` را وارد می‌کند.
   - **قدم‌ها**:
     1. نام کاربر در لیست `known_members` تأیید می‌شود.
     2. پیام خوش‌آمدگویی با لیست قرآن‌آموزان گروه و تاریخ جاری ارسال می‌شود.
     3. از کاربران جدید دعوت می‌شود تا با دستور `/عضو` ثبت‌نام کنند.
   - **هدف**: ثبت رسمی کاربر در گروه و نمایش لیست اعضا.

### ۳. **ارسال تمرین تلاوت**
   - **شرایط**: کاربر غیرادمین فایل صوتی (voice یا audio) با کپشن حاوی کلمات "تلاوت"، "تمرین" یا "ارسال تلاوت" ارسال می‌کند.
   - **قدم‌ها**:
     1. ربات بررسی می‌کند که آیا امروز (شنبه، دوشنبه یا چهارشنبه) روز تمرین است.
     2. اگر روز تمرین نباشد و مهلت ارسال تمام شده باشد، پیام خطا نمایش داده می‌شود.
     3. اگر پیام شامل فایل صوتی و کپشن معتبر باشد:
        - اطلاعات تمرین (وضعیت: ارسال‌شده، تاریخ، شناسه پیام، روز تمرین) در `recitation_exercises` ذخیره می‌شود.
        - گزارش تمرین‌ها با استفاده از تابع `generate_exercise_report` تولید و ارسال می‌شود.
   - **هدف**: ثبت تمرین تلاوت و ارائه گزارش وضعیت.

### ۴. **نمره‌دهی توسط ادمین**
   - **شرایط**: ادمین به پیام تمرین کاربر پاسخ می‌دهد و یکی از کلمات "عالی"، "خوب" یا "بد" را وارد می‌کند.
   - **قدم‌ها**:
     1. ربات بررسی می‌کند که فرستنده ادمین است و پیام پاسخ به یک تمرین معتبر است.
     2. نمره در `recitation_exercises` و `exercise_scores` ذخیره می‌شود.
     3. پیام تأیید نمره با جزئیات (نام کاربر، نمره، تاریخ) و گزارش کامل تمرین‌ها ارسال می‌شود.
   - **هدف**: ثبت و اطلاع‌رسانی نمره تمرین.

### ۵. **گزارش‌گیری**
   - **گزارش تمرین‌ها (`/گزارش`)**:
     - **شرایط**: ادمین دستور `/گزارش` را وارد می‌کند.
     - **قدم‌ها**:
       1. گزارش شامل وضعیت تمرین‌ها (ارسال‌شده، در انتظار بررسی، در انتظار تمرین)، درصد مشارکت، پیام انگیزشی و مهلت ارسال تمرین تولید می‌شود.
       2. گزارش به گروه ارسال می‌شود.
     - **هدف**: ارائه دید کلی از وضعیت تمرین‌های گروه.
   - **گزارش نمرات (`/نمرات`)**:
     - **شرایط**: ادمین دستور `/نمرات` را وارد می‌کند.
     - **قدم‌ها**:
       1. گزارش شامل دسته‌بندی کاربران بر اساس آخرین نمره (عالی، خوب، بد) و لیست کاربران بدون تمرین تولید می‌شود.
       2. آمار کلی (تعداد کاربران در هر دسته) و پیام انگیزشی اضافه می‌شود.
       3. گزارش به گروه ارسال می‌شود.
     - **هدف**: نمایش وضعیت نمرات اعضای گروه.
   - **لیست اعضا (`/لیست`)**:    
     - **شرایط**: هر کاربر می‌تواند دستور `/لیست` را وارد کند.
     - **قدم‌ها**:
       1. لیست ادمین‌ها و قرآن‌آموزان با آمار کلی (تعداد ادمین‌ها، قرآن‌آموزان، کل اعضا) تولید می‌شود.
       2. اگر تعداد اعضای شناخته‌شده کمتر از کل اعضای گروه باشد، درخواست `/عضو` نمایش داده می‌شود.
       3. گزارش به گروه ارسال می‌شود.
     - **هدف**: نمایش لیست اعضا و آمار گروه.

---
  
## سناریوی نظرسنجی و درباره ربات

### ۱. **نظرسنجی**
   - **شرایط**: کاربر روی دکمه "نظرسنجی" کلیک می‌کند.
   - **قدم‌ها**:
     1. پیام نظرسنجی با توضیحات (کیفیت خدمات، سهولت استفاده، پیشنهادات بهبود) نمایش داده می‌شود.
     2. دکمه‌های شیشه‌ای "عالی"، "خوب" و "نیاز به بهبود" ارائه می‌شود.
     3. پس از انتخاب، پیام تشکر با گزینه انتخاب‌شده نمایش داده می‌شود و منوی اصلی باز می‌گردد.
   - **هدف**: جمع‌آوری بازخورد کاربران.

### ۲. **درباره ربات**
   - **شرایط**: کاربر روی دکمه "درباره ربات" کلیک می‌کند.
   - **قدم‌ها**:
     1. اطلاعات ربات (قابلیت‌ها، توسعه‌دهنده، نسخه) نمایش داده می‌شود.
     2. دکمه "بازگشت به منو" ارائه می‌شود.
   - **هدف**: ارائه اطلاعات کلی درباره ربات.

---

## سناریوی معرفی مدرسه تلاوت
   - **شرایط**: کاربر جدید روی دکمه "معرفی مدرسه تلاوت" کلیک می‌کند.
   - **قدم‌ها**:
     1. متن معرفی شامل خدمات، اهداف آموزشی و اطلاعات تماس نمایش داده می‌شود.
     2. دکمه‌های "ثبت‌نام در مدرسه" و "بازگشت به منو" ارائه می‌شود.
   - **هدف**: معرفی مدرسه به کاربران جدید و تشویق به ثبت‌نام.

---

## نکات فنی و محدودیت‌ها
1. **ذخیره‌سازی داده‌ها**: اطلاعات کاربران در `1.txt` ذخیره می‌شود و فقط آخرین اطلاعات هر کاربر نگه داشته می‌شود (بدون تکرار).
2. **مدیریت خطاها**: در صورت بروز خطا (شبکه یا غیره)، تأخیر بین درخواست‌ها افزایش می‌یابد.
3. **محدودیت API بله**: امکان دریافت تمام اعضای گروه وجود ندارد، بنابراین کاربران باید با `/عضو` ثبت‌نام کنند.
4. **روزهای تمرین**: تمرین‌ها فقط در روزهای شنبه، دوشنبه و چهارشنبه پذیرفته می‌شوند، با مهلت‌های مشخص (تا پایان همان روز یا روزهای بعد).
5. **پیام‌های انگیزشی**: هر گزارش شامل یک پیام انگیزشی تصادفی از لیست `motivational_quotes` است.

---

## فایل Markdown
این سناریو در فایل `scenario.mid` ذخیره شده است و می‌توانید آن را دانلود و مطالعه کنید. فایل شامل تمام مراحل و جزئیات عملکرد ربات به‌صورت سازمان‌یافته است.